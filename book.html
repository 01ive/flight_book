<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Tableau des vols</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            font-size: 14px;
        }

        #graphs {
            display: flex;
            height: 33vh;
            align-items: stretch;
            justify-content: space-around;
        }

        #nbVolsChart {
            max-width: 50%;
        }

        #nbVolsSolo {
            max-width: 100%;
        }

        #nbVolsSites {
            max-width: 25%;
        }

        #distanceChart {
            margin: 20px auto;
            height: 33vh;
        }
    </style>
</head>

<body>
    <h2>Journal des vols</h2>

    <button id="saveJsonBtn">üíæ T√©l√©charger le JSON</button>

    <div id="menu_button">
        <label id="my-file-selector" for="file-selector"></label>
        <input type="file" id="file-selector" accept=".igc, .gpx">
    </div>

    <table id="volsTable" class="display">
        <thead>
            <tr>
                <th>Nbr</th>
                <th>Date</th>
                <th>Site</th>
                <th>Start time</th>
                <th>Dur√©e</th>
                <th>Distance (m)</th>
                <th>elevation gains</th>
                <th>elevation over start</th>
                <th>Analyse</th>
                <th>Monitor</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="graphs">
        <!-- Chart.js container -->
        <canvas id="nbVolsChart" height="100"></canvas>

        <!-- Chart.js container -->
        <canvas id="nbVolsSolo"></canvas>

        <!-- Chart.js container -->
        <canvas id="nbVolsSites"></canvas>
    </div>
    <!-- Chart.js container -->
    <canvas id="distanceChart" height="100"></canvas>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="bundle.js"></script>

    <script>
        const volsParAn = {}; // Regrouper les donn√©es par ann√©e
        const volsParSite = {};

        var book_data = null;

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            const dates = [], distances = [];

            // Reinit table data
            tbody.innerHTML = '';
            $('#volsTable').DataTable().clear().destroy();
            // Reinit charts
            const allCharts = Chart.instances ? Object.values(Chart.instances) : [];
            allCharts.forEach(chart => chart.destroy());

            book_data = data;

            data.forEach(vol => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${vol.nbr}</td>
                    <td>${vol.date}</td>
                    <td>${vol.site}</td>
                    <td>${vol.start_time}</td>
                    <td>${vol.duration}</td>
                    <td>${vol.distance_total.toFixed(1)}</td>
                    <td>${vol.elevation_total.toFixed(1)}</td>
                    <td>${vol.elevation_over_start.toFixed(1)}</td>
                    <td>${vol.analyse}</td>
                    <td>${vol.monitor}</td>
                `;
                tbody.appendChild(tr);

                // Pour les graphiques
                dates.push(vol.date);
                distances.push((vol.distance_total / 1000).toFixed(2)); // en km

                const annee = new Date(vol.date).getFullYear();
                // Initialisation des donn√©es par ann√©e
                if (!volsParAn[annee]) {
                    volsParAn[annee] = {
                        nb: 0,
                        totalMinutes: 0,
                        solo: 0
                    };
                }
                // Vol par site
                let sites = vol.site.split(" ");
                let siteShort = "";

                for (word in sites) {
                    siteShort += sites[word].toLowerCase();
                    if (sites[word].length < 4) {
                        siteShort += " ";
                    } else {
                        break;
                    }
                }

                if (!volsParSite[siteShort]) {
                    volsParSite[siteShort] = 0;
                }
                volsParSite[siteShort] += 1;
                // Compter le vol
                volsParAn[annee].nb += 1;
                // Compter les vols solo
                if (vol.monitor === 'None') {
                    volsParAn[annee].solo += 1;
                }
                // Ajouter dur√©e (en minutes)
                const [h, m, s] = vol.duration.split(':').map(Number);
                volsParAn[annee].totalMinutes += h * 60 + m + s / 60;
            });

            // Activer DataTables
            $('#volsTable').DataTable({
                order: [[0, 'dec']],  // ü†î Tri sur la premi√®re colonne, descendant
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json'
                }
            });

            // Cr√©er le graphique de distance
            new Chart(document.getElementById('distanceChart'), {
                type: 'bar',
                data: {
                    labels: dates.reverse(),
                    datasets: [{
                        label: 'Distance totale (km)',
                        data: distances.reverse(),
                        backgroundColor: '#3e95cd'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Ordre chronologique
            const annees = Object.keys(volsParAn).sort();

            // Donn√©es pour les graphiques
            const nbVols = annees.map(a => volsParAn[a].nb);
            const tpsVols = annees.map(a => volsParAn[a].totalMinutes / 60);

            // Nombre de vols
            new Chart(document.getElementById('nbVolsChart'), {
                type: 'bar',
                data: {
                    labels: annees,
                    datasets: [{
                        label: 'Nombre de vols',
                        data: nbVols,
                        backgroundColor: '#4caf50',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Temps de vol (h)',
                        data: tpsVols,
                        backgroundColor: '#2196f3',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            // beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nombre de vols'
                            }
                        },
                        y1: {
                            // beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Temps de vol (h)'
                            },
                            grid: {
                                drawOnChartArea: false // Ne pas dessiner la grille pour cette √©chelle
                            }
                        }
                    }
                }
            });

            nbVolsSolo = annees.map(a => volsParAn[a].solo);
            let total_vols = nbVols.reduce(
                (accumulator, currentValue) => accumulator + currentValue,
                initialValue = 0,
            );
            let total_vols_solo = nbVolsSolo.reduce(
                (accumulator, currentValue) => accumulator + currentValue,
                initialValue = 0,
            );
            let total_vols_ecole = total_vols - total_vols_solo;

            // Nombre de vols solo
            // Cr√©er le graphique de distance
            new Chart(document.getElementById('nbVolsSolo'), {
                type: 'pie',
                data: {
                    labels: ['Vols √©cole', 'Vols solo'],
                    datasets: [{
                        label: 'Nombre de vols',
                        data: [total_vols_ecole, total_vols_solo],
                        backgroundColor: ['#4caf50', '#2196f3']
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'Vols solo / √©cole'
                        }
                    }
                }
            });

            // Graphique des vols par site
            let volsParSiteName = Object.entries(volsParSite).map(a => a[0]);
            let volsParSiteValues = Object.entries(volsParSite).map(a => a[1]);
            new Chart(document.getElementById('nbVolsSites'), {
                type: 'pie',
                data: {
                    labels: volsParSiteName,
                    datasets: [{
                        label: 'Sites de vols',
                        data: volsParSiteValues
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'Sites'
                        }
                    }
                }
            });
        }

        fetch('book.json')
        // fetch('https://drive.google.com/uc?export=download&id=1W1dxk2-_e2nrIFApyKcDRbvXftNV_RiY')
            .then(response => response.json())
            .then(data => updateTable(data));

        // Ajoute l‚Äô√©v√©nement sur le bouton
        document.getElementById('saveJsonBtn').addEventListener('click', function () {
            const blob = new Blob([JSON.stringify(book_data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vols-export.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Create file reader object
        var file_name = null;
        const file_reader = new FileReader();
        file_reader.addEventListener('load', (event) => {
            let flight = new Flight("flight");
            flight.load_file(event.target.result, file_name);
            active_flight = flight;
            active_flight.process_flight_info();

            var new_flight_data = {};
            new_flight_data = active_flight.flight_info;
            new_flight_data.file_name = active_flight.file_name;
            new_flight_data.nbr = book_data[0]['nbr']+1;

            new_flight_data.site = "None";
            new_flight_data.monitor = "None";
            let comments = active_flight.comment.split('\n');

            for(line in comments) {
                if (comments[line].search("site:") >= 0) {
                    new_flight_data.site = comments[line].replace("site:", "").trim();
                }
                if (comments[line].search("monitor:") >= 0) {
                    new_flight_data.monitor = comments[line].replace("monitor:", "").trim();
                }
            }
            comments = comments.join('\n');
            new_flight_data.analyse = comments.replace(/site:.*\n/, '').replace(/monitor:.*\n/, '').trim();

            book_data.unshift(new_flight_data);            
            updateTable(book_data);
        });

        // Load file button
        const fileSelector = document.getElementById('file-selector');
        fileSelector.addEventListener('change', (event) => {
            const fileList = event.target.files;
            file_name = fileList[0].name;	// Get only the file name
            file_reader.readAsText(fileList[0]);
        });

    </script>

</body>

</html>